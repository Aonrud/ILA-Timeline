/*! Timeline
 *Copyright (C) 2021 Aonghus Storey
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).Timeline=e()}(this,(function(){"use strict";const t="http://www.w3.org/2000/svg";class e{static draw({start:e,end:s,stroke:i,colour:o,markers:n=[],dashes:r="",title:h=""}={}){const c=2*i,a=s.x-e.x,d=s.y-e.y,l={x1:c,y1:c,x2:a+c,y2:d+c};s.x<e.x&&(l.x1+=Math.abs(a),l.x2+=Math.abs(a)),s.y<e.y&&(l.y1+=Math.abs(d),l.y2+=Math.abs(d));const u=Math.min(e.x,s.x)-c,f=Math.min(e.y,s.y)-c;let m=document.createElementNS(t,"svg");m.setAttribute("width",Math.abs(a)+2*c),m.setAttribute("height",Math.abs(d)+2*c),m.setAttribute("style","position: absolute; left: "+u+"px; top: "+f+"px"),m.style.color=o;const p=this.drawLine(l,i,r,h);return p.setAttribute("data-coords",`[ ${e.x}, ${e.y} ], [ ${s.x}, ${s.y} ]`),m.append(p),m=this.t(m,n[0],"start",l,i),m=this.t(m,n[1],"end",l,i),m}static t(t,e,s,i,o){return"circle"==e&&t.append(this.i(s,i,o)),"square"==e&&t.append(this.o(s,i,o)),"dots"==e&&"end"==s&&(t.setAttribute("width",parseInt(t.getAttribute("width"))+2*o),t.append(this.h(i,o))),t}static o(t,e,s){let[i,o]=[e.x1-s,e.y1-s];return"end"==t&&([i,o]=[e.x2-s,e.y2-s]),this.drawSquare(i,o,2.5*s)}static i(t,e,s){let[i,o]=[e.x1,e.y1];return"end"==t&&([i,o]=[e.x2,e.y2]),this.drawCircle(i,o,s)}static h(t,e){let s=t.x2;t.x2<t.x1&&(s=t.x2-5*e),t.x2>t.x1&&(s=t.x2+5*e);let i=t.y2;t.y2<t.y1&&(i=t.y2-2*e),t.y2>t.y1&&(i=t.y2+2*e);const o={x1:t.x2,y1:t.y2,x2:s,y2:i};return this.drawLine(o,e,`0 ${e} ${e} ${e} ${e}`)}static drawLine(e,s,i="",o=""){const n=document.createElementNS(t,"line");return n.setAttribute("x1",e.x1),n.setAttribute("y1",e.y1),n.setAttribute("x2",e.x2),n.setAttribute("y2",e.y2),n.setAttribute("stroke-width",s),n.setAttribute("stroke-dasharray",i),n.setAttribute("stroke","currentColor"),o&&n.append(this.l(o)),n}static drawCircle(e,s,i,o=""){const n=document.createElementNS(t,"circle");return n.setAttribute("cx",e),n.setAttribute("cy",s),n.setAttribute("r",i),n.setAttribute("fill","currentColor"),o&&n.append(this.l(o)),n}static drawSquare(e,s,i,o=""){const n=document.createElementNS(t,"rect");return n.setAttribute("x",e),n.setAttribute("y",s),n.setAttribute("width",i),n.setAttribute("height",i),n.setAttribute("fill","currentColor"),o&&n.append(this.l(o)),n}static l(e){const s=document.createElementNS(t,"title");return s.append(document.createTextNode(e)),s.dataset.title=e,s}}class s{constructor(t,e,s){this.u=t,this.m=e,this.p=s,this.g=s-e,this._=this.v(t),this.$=this.k(t);let i={};for(const t of this.$)i[t]=this.v();this.I=i}calculate(){const t=[...this.u].filter((t=>t.dataset.group)),e=[...this.u].filter((t=>!t.dataset.group));for(const e of t)this.S(e,!0);let s=0;this.$.forEach(((t,e)=>{const i=[...this.u].filter((e=>e.dataset.group==t));if(0!=e){const i=this.I[this.$[e-1]],o=this.O(i,this.I[t]);s-=o}for(const t of i)t.dataset.row=parseInt(t.dataset.groupRow)+s;s+=this.I[t].length}));const i=this.C(this.u);this.G(this._,i);for(const e of t)this.M(e.dataset.row,this.j(e.dataset.start),this.j(e.dataset.end),this._);for(const t of e)this.S(t)}get rows(){return this._.length}k(t){return[...t].reduce(((t,e)=>(e.dataset.group&&!t.includes(e.dataset.group)&&t.push(e.dataset.group),t)),[])}S(t,e=!1){let s=this._,i="row";if(e){if(!t.dataset.group)return;s=this.I[t.dataset.group],i="groupRow"}if(t.dataset[i])return;const o=this.j(t.dataset.start),n=this.j(this.F(t));let r=null,h=null;if(t.dataset.split&&(r=document.getElementById(t.dataset.split)),t.dataset.merge){const e=document.getElementById(t.dataset.merge);e.dataset.split!==t.id&&(r=e)}!r||e&&r.dataset.group!=t.dataset.group||(Object.hasOwn(r.dataset,i)||this.S(r,e),h=parseInt(r.dataset[i]));const c=this.T(o,n,s,h);t.dataset[i]=c,this.R(t,i,s);try{this.M(c,o,n,s)}catch(e){console.warn(`${e}: called for ${t.id} with row ${c}`)}}R(t,e,s){if(t.dataset.become){const i=document.getElementById(t.dataset.become);t.dataset.group!==i.dataset.group&&(console.warn(`${t.id} and ${i.id} are directly connected but in separate groups. Amending ${i.id} to ${t.dataset.group}`),i.dataset.group=t.dataset.group),Object.hasOwn(i.dataset,e)&&this.A(i.dataset[e],this.j(i.dataset.start),this.j(i.dataset.end),s),i.dataset[e]=t.dataset[e],this.R(i,e,s)}}F(t){let e=t.dataset.end;return t.dataset.become&&(e=this.F(document.getElementById(t.dataset.become))),e}O(t,e){let s=Math.min(t.length,e.length)-1;for(;s>0;){let i=!0;for(let o=0;o<s&&o<t.length;o++)if(!this.D(t[t.length-s+o],e[o])){i=!1;break}if(1==i)return s;s--}return s}v(t=null){let e=1,s=[];t&&(e=this.C(t));let i=Array.from(Array(e),(()=>new Array(this.g).fill(!1)));for(const t of s)i=this.M(t.dataset.row,this.j(t.start),this.j(t.end),i);return i}C(t){const e=[...t].filter((t=>t.dataset.row));return e.length>0?Math.max(...e.map((t=>parseInt(t.dataset.row))))+1:1}T(t,e,s,i=null){let o=i||Math.floor(s.length/2),n=!1;for(let i=0;i<s.length;i++)if(o=n?o-i:o+i,!(o<0||o>s.length-1)){if(this.q(o,t,e,s))return o;n=!n}return this.P(s),s.length-1}j(t){return parseInt(t)-parseInt(this.m)}G(t,e){for(;t.length-1!==e;)this.P(t);return t}P(t){return t.push(new Array(this.g).fill(!1)),t}q(t,e,s,i){e===s&&(s+=1);return i[t].slice(e,s).every((t=>!1===t))}M(t,e,s,i){return this.J(t,e,s,i,!0),i}A(t,e,s,i){return this.J(t,e,s,i,!1),i}J(t,e,s,i,o){if(!i[t])throw new Error(`Attempt to mark non-existent grid row ${t}. Grid has length ${i.length}`);let n=0;for(;n<s-e;)i[t][e+n]=o,n++;return e>0&&(i[t][e-1]=o),s<i[0].length-1&&(i[t][s]=o),i}D(t,e){for(const[s,i]of t.entries())if(i&&e[s])return!1;return!0}}function i(t,e){let s={};for(const i in t)Object.hasOwn(e,i)?s[i]=e[i]:s[i]=t[i];return s}const o={yearStart:1900,yearEnd:(new Date).getFullYear()+1,strokeWidth:4,yearWidth:50,rowHeight:50,padding:5,boxWidth:100,guides:!0,guideInterval:5,entrySelector:"div",linkDashes:"4",irregularDashes:"88 4 4 4"};class n{constructor(t,e={}){this.L=this.W(e),this.N(),this.H=document.getElementById(t),this.u=document.querySelectorAll("#"+t+" > "+this.L.entrySelector+":not(.timeline-exclude):not(.event)"),this.U=this.H.querySelectorAll(".event")}W(t){const e=i(o,t);return e.boxHeight=e.rowHeight-2*e.padding,e.boxMinWidth=e.boxHeight,e}X(t,e){this.L[t]=e}create(){return this.Y(),this.B(),this.K(),!0===this.L.guides&&this.V(),this.H}Y(){this.Z(),this.tt(),this.H.classList.add("timeline-container"),this.H.style.height=(this.L.rows+2)*this.L.rowHeight+"px",this.H.style.width=(this.L.yearEnd+1-this.L.yearStart)*this.L.yearWidth+"px",this.et(),this.st()}Z(){for(const t of this.u){t.classList.add("entry"),t.dataset.end=this.it(t),parseInt(t.dataset.start)<this.L.yearStart&&(t.classList.add("preexists"),t.dataset.start=this.L.yearStart);for(const e of["become","split","merge","links"])if(Object.hasOwn(t.dataset,e))for(const s of t.dataset[e].split(" "))document.getElementById(s)||(console.warn(`${t.id}: Given ${e} ID "${s}" doesn't exist. Ignoring.`),delete t.dataset[e])}}tt(){let t=1;for(const e of this.u)parseInt(e.dataset.row)>t&&(t=parseInt(e.dataset.row));const e=new s(this.u,this.L.yearStart,this.L.yearEnd);e.calculate(),t=e.rows,this.X("rows",t)}et(){for(const t of this.u)t.style.left=this.ot(t.dataset.start)+"px",t.style.top=this.nt(t)+"px",t.dataset.colour&&(t.style.borderColor=t.dataset.colour),!0===this.rt(t)&&t.classList.add("min");for(const t of this.H.querySelectorAll(this.L.entrySelector+"[data-become]"))t.dataset.start==document.getElementById(t.dataset.become).dataset.start&&(t.style.left=parseFloat(t.style.left)-this.L.boxMinWidth/2+"px",document.getElementById(t.dataset.become).style.left=parseFloat(document.getElementById(t.dataset.become).style.left)+this.L.boxMinWidth/2+"px")}st(){for(const t of this.U){if(t.dataset.target&&!document.getElementById(t.dataset.target)){console.warn(`Event has an invalid target â€“ skipping: ${JSON.stringify(t)}`);continue}let e=this.L.rowHeight-t.offsetHeight,s=this.ot(t.dataset.year);const i=[...this.U].filter((e=>!e.dataset.target&&e.dataset.year==t.dataset.year));i.length>1&&0!==i.indexOf(t)&&(e-=.5*t.offsetHeight*i.indexOf(t));const o=document.createElement("span");if(o.dataset.year=t.dataset.year,o.innerText=t.innerText,t.innerText="",t.append(o),t.dataset.colour){const e=`colour-${t.dataset.colour.replace(/[!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~]/g,"")}`;t.classList.add(e);let s=`.event:not([data-target]).${e}:after { color: ${t.dataset.colour}; border-color: ${t.dataset.colour} }`;s+=`.event.${e}:hover span { color: ${t.dataset.colour} }`,this.ht(s)}if(t.dataset.target){const i=document.getElementById(t.dataset.target);if(e=this.nt(i)+.5*(this.L.boxHeight-t.offsetHeight),s-=.5*t.offsetWidth,i.dataset.colour){const t=`.event[data-target="${i.id}"] {border-color: ${i.dataset.colour}; color: ${i.dataset.colour}; background-color: ${i.dataset.colour};}`;this.ht(t)}}t.style.left=s+"px",t.style.top=e+"px"}}ht(t){if(!document.getElementById("tl-styles")){const t=document.createElement("style");t.id="tl-styles",t.setAttribute("type","text/css"),document.head.append(t)}document.getElementById("tl-styles").append(document.createTextNode(t))}K(){const t=document.createElement("div");t.classList.add("dates");let e=this.L.yearStart;for(;e<this.L.yearEnd;){const s=document.createElement("date");s.style.left=this.ot(e)+"px";const i=document.createTextNode(e);s.append(i),t.append(s),e+=5}this.H.prepend(t);const s=t.cloneNode(!0);s.style.top=this.L.rows*this.L.rowHeight+"px",this.H.append(s)}V(){let t=this.L.yearStart;for(;t<Math.ceil(this.L.yearEnd/this.L.guideInterval)*this.L.guideInterval;){const e=document.createElement("div");e.classList.add("guide"),e.style.left=this.ot(t)+"px",e.style.width=this.L.yearWidth*this.L.guideInterval+"px",(t-this.L.yearStart)/this.L.guideInterval%2==1&&e.classList.add("odd"),this.H.append(e),t+=this.L.guideInterval}}B(){for(const t of this.u){const s=t.dataset.colour?t.dataset.colour:"var(--tl-colour-stroke)",i="true"==t.dataset.irregular?this.L.irregularDashes:"";let o="",n="end",r=this.ct(t,"right"),h={x:this.ot(t.dataset.end),y:r.y};if(Object.hasOwn(t.dataset,"merge")||Object.hasOwn(t.dataset,"become")||(o=t.dataset.endEstimate?"dots":"circle"),Object.hasOwn(t.dataset,"become")&&(h=this.ct(document.getElementById(t.dataset.become),"left"),n="become"),Object.hasOwn(t.dataset,"merge")){t.dataset.start==t.dataset.end&&(h.x+=this.L.yearWidth);const i={x:h.x,y:this.dt(document.getElementById(t.dataset.merge))};h.x=h.x-this.L.yearWidth;const o=e.draw({start:h,end:i,stroke:this.L.strokeWidth,colour:s});o.classList.add("merge"),this.H.append(o),n="merge"}if(t.dataset.start!==t.dataset.end){const t=e.draw({start:r,end:h,stroke:this.L.strokeWidth,colour:s,markers:["",o],dashes:i});t.classList.add(n),this.H.append(t)}Object.hasOwn(t.dataset,"split")&&this.lt(t,s),Object.hasOwn(t.dataset,"links")&&this.ut(t,s)}}lt(t,s){const i=document.getElementById(t.dataset.split);let o="top";parseInt(t.dataset.row)<parseInt(i.dataset.row)&&(o="bottom");const n={x:this.ot(t.dataset.start),y:this.dt(i)},r=this.ct(t,o),h=e.draw({start:n,end:r,stroke:this.L.strokeWidth,colour:s});h.classList.add("split"),this.H.append(h)}ut(t,s){const i=t.dataset.links.split(" ");let o={top:-1,bottom:-1,left:-1,right:-1};for(const n of i){const i=document.getElementById(n);let r,h,c={x:0,y:0},a={x:0,y:0};const d=parseInt(t.dataset.row),l=parseInt(i.dataset.row);if(d===l)continue;d===l&&t.dataset.start<i.dataset.start&&(o.right=o.right+1,r="right",h="left"),d===l&&t.dataset.start>i.dataset.start&&(o.left=o.left+1,r="left",h="right"),d>l&&(o.top=o.top+1,r="top",h="bottom"),d<l&&(o.bottom=o.bottom+1,r="bottom",h="top");try{c=this.ct(t,r,o[r])}catch{throw new Error(`${t.id}: tried to calc with ${r} and ${o[r]}`)}a={x:c.x,y:this.dt(i)},t.dataset.start>=i.dataset.end&&(a.x=this.ot(i.dataset.end)),t.dataset.start==i.dataset.start&&(a=this.ct(i,h));const u=e.draw({start:c,end:a,stroke:this.L.strokeWidth/2,colour:s,markers:["square","square"],dashes:this.L.linkDashes});u.classList.add("link"),this.H.append(u)}}N(){const t=document.documentElement;t.style.setProperty("--tl-width-year",this.L.yearWidth+"px"),t.style.setProperty("--tl-height-row",this.L.rowHeight+"px"),t.style.setProperty("--tl-width-box",this.L.boxWidth+"px"),t.style.setProperty("--tl-height-box",this.L.boxHeight+"px"),t.style.setProperty("--tl-width-box-min",this.L.boxHeight+"px"),t.style.setProperty("--tl-padding",this.L.padding+"px")}ct(t,e,s=0){const i=window.getComputedStyle(t),o=parseFloat(t.style.left),n=parseFloat(t.style.top),r=parseFloat(i.getPropertyValue("width")),h=parseFloat(i.getPropertyValue("height"));switch(e){case"left":return{x:o,y:n+h/2+5*s};case"right":return{x:o+r,y:n+h/2+5*s};case"top":return{x:o+r/2+5*s,y:n};case"bottom":return{x:o+r/2+5*s,y:n+h};default:throw`Invalid element side specified: Called with ${e}. Entry: ${t}`}}it(t){return t.dataset.end?parseInt(t.dataset.end):t.dataset.become?parseInt(document.getElementById(t.dataset.become).dataset.start):parseInt(this.L.yearEnd)}nt(t){return parseInt((parseInt(t.dataset.row)+1)*this.L.rowHeight+this.L.padding)}rt(t){const e=t.dataset.start;return t.dataset.end-e<this.L.boxWidth/this.L.yearWidth}ft(t){return parseFloat(t.style.left)+this.L.boxWidth/2}dt(t){return parseFloat(t.style.top)+this.L.boxHeight/2}ot(t){return parseInt((t-this.L.yearStart)*this.L.yearWidth)}}const r={panzoom:null,findForm:"timeline-find",zoomIn:"timeline-zoom-in",zoomOut:"timeline-zoom-out",zoomReset:"timeline-zoom-reset"};return class{constructor(t="diagram",e={},s=[],i=[]){this.H=t,this.wt(e);for(const t of s)this.addEntry(t);for(const t of i)this.addEvent(t)}create(){const t=new n(this.H,this.yt);this.gt=t.create(),"function"==typeof this.L.panzoom&&(this.xt(),this._t(),window.addEventListener("hashchange",(t=>this.vt(t)))),location.hash&&setTimeout((()=>{this.vt()}))}wt(t){this.L=i(r,t),this.yt=i(o,t)}addEntry(t){if(document.getElementById(t.id))return void console.warn(`Invalid entry: ${t.id} already exists.`);if(!["id","name","start"].every((e=>Object.hasOwn(t,e))))return void console.warn(`Invalid entry: ${JSON.stringify(t)}. Entries must have at least id, name and start values.`);const e=document.createElement("div");e.id=t.id,e.innerText=t.name;for(const s of Object.keys(t))["id","name"].includes(s)||(e.dataset[s]=t[s]);document.getElementById(this.H).append(e)}addEvent(t){if(!t.year||!t.content)return void console.warn(`Invalid event: ${JSON.stringify(t)}. Events must have at least a year and content property.`);const e=document.createElement("div");e.classList.add("event"),e.innerText=t.content;for(const s of Object.keys(t))"content"!=s&&(e.dataset[s]=t[s]);document.getElementById(this.H).append(e)}panToEntry(t){if(void 0===this.$t)throw new Error("Panzoom module missing. Include Panzoom to use the pan-to-entry feature.");const e=document.getElementById(t),s=window.innerWidth/2-parseInt(e.style.left)-this.yt.boxWidth/2,i=window.innerHeight/2-parseInt(e.style.top)-this.yt.rowHeight/2;this.$t.zoom(1),this.$t.pan(s,i);const o=new CustomEvent("timelineFind",{detail:{id:t,name:e.innerText}});document.getElementById(this.H).dispatchEvent(o),setTimeout((()=>{e.classList.add("highlight","hover")}),500),setTimeout((()=>{e.classList.remove("highlight","hover")}),2e3)}_t(){const t=document.getElementById(this.L.zoomIn),e=document.getElementById(this.L.zoomOut),s=document.getElementById(this.L.zoomReset),i=document.getElementById(this.L.findForm);t&&t.addEventListener("click",this.$t.zoomIn),e&&e.addEventListener("click",this.$t.zoomOut),s&&s.addEventListener("click",(()=>this.$t.zoom(1))),i&&this.bt(i)}bt(t){const e=document.createElement("input");e.name="find-id",e.style.display="none",t.append(e);const s=t.querySelector("input[name=finder]"),i=document.createElement("div"),o=document.createElement("div"),n=document.createElement("ul");i.classList.add("filtered-entries"),i.appendChild(o),o.appendChild(n),s.parentNode.insertBefore(i,s),i.appendChild(s),s.autocomplete="off",o.style.width=s.offsetWidth+"px";const r={form:t,finder:s,id:e,results:n};this.kt=r,r.finder.value="",t.addEventListener("input",(t=>this.It(t))),t.addEventListener("submit",(t=>this.Et(t))),n.addEventListener("click",(t=>this.St(t)))}It(t){const e=t.target.value;if(""===e.trim())return this.kt.results.innerHTML="",null;const s=this.Ot(e),i=this.kt.results;i.innerHTML="";for(const t of s){const e=document.createElement("li");e.dataset.id=t.id,e.innerText=t.name,i.append(e)}}Ot(t){return[...document.querySelectorAll(".entry")].map((t=>({id:t.id,name:t.innerText}))).filter((e=>e.name.toLowerCase().includes(t.toLowerCase())))}St(t){if("li"!==t.target.localName)return null;const e=this.kt.form,s=this.kt.finder,i=this.kt.id;s.value=t.target.innerText,i.value=t.target.dataset.id,e.requestSubmit()}Et(t){t.preventDefault();const e=t.target.querySelector("input[name=find-id]").value;document.getElementById(e)&&this.panToEntry(e),this.kt.results.innerHTML="",this.kt.finder.value=""}xt(){const t=document.createElement("div");t.classList.add("pz-wrap"),this.gt.parentNode.insertBefore(t,this.gt),t.appendChild(this.gt),this.$t=this.L.panzoom(this.gt,{contain:"outside",maxScale:3,minScale:.5,step:.1,handleStartEvent:t=>{t.preventDefault()}}),this.gt.parentElement.addEventListener("wheel",this.$t.zoomWithWheel)}vt(){const t=location.hash.replace("#find-","");document.getElementById(t)&&this.$t&&this.panToEntry(t)}}}));
