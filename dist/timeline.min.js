/*! Timeline
 *Copyright (C) 2021 Aonghus Storey
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(t,i){"object"==typeof exports&&"undefined"!=typeof module?module.exports=i():"function"==typeof define&&define.amd?define(i):(t="undefined"!=typeof globalThis?globalThis:t||self).Timeline=i()}(this,(function(){"use strict";const t="http://www.w3.org/2000/svg";class i{static draw({start:i,end:s,stroke:e,colour:o,markers:n=[],dashes:r="",title:h=""}={}){const c=2*e,a=s.x-i.x,d=s.y-i.y,u={x1:c,y1:c,x2:a+c,y2:d+c};s.x<i.x&&(u.x1+=Math.abs(a),u.x2+=Math.abs(a)),s.y<i.y&&(u.y1+=Math.abs(d),u.y2+=Math.abs(d));const l=Math.min(i.x,s.x)-c,m=Math.min(i.y,s.y)-c,p=document.createElementNS(t,"svg");p.setAttribute("width",Math.abs(a)+2*c),p.setAttribute("height",Math.abs(d)+2*c),p.setAttribute("style","position: absolute; left: "+l+"px; top: "+m+"px");const f=this.drawLine(u,o,e,r,h);f.setAttribute("data-coords",`[ ${i.x}, ${i.y}], [ ${s.x}, ${s.y} ]`),p.append(f);const w=this.t(n[0],"start",u,e,o);w&&p.append(w);const y=this.t(n[1],"end",u,e,o);return y&&p.append(y),p}static t(t,i,s,e,o){return"circle"==t?this.i(i,s,e,o):"square"==t?this.o(i,s,e,o):"dots"==t&&"end"==i?this.h(s,e,o):void 0}static o(t,i,s,e){let[o,n]=[i.x1-s,i.y1-s];return[o,n]=[i.x2-s,i.y2-s],this.drawSquare(o,n,2.5*s,e)}static i(t,i,s,e){let[o,n]=[i.x1,i.y1];return[o,n]=[i.x2,i.y2],this.drawCircle(o,n,s,e)}static h(t,i,s){let e=t.x2;t.x2<t.x1&&(e=t.x2-2*i),t.x2>t.x1&&(e=t.x2+2*i);let o=t.y2;t.y2<t.y1&&(o=t.y2-2*i),t.y2>t.y1&&(o=t.y2+2*i);const n={x1:t.x2,y1:t.y2,x2:e,y2:o};return this.drawLine(n,s,2*i,"2 2")}static drawLine(i,s,e,o="",n=""){const r=document.createElementNS(t,"line");return r.setAttribute("x1",i.x1),r.setAttribute("y1",i.y1),r.setAttribute("x2",i.x2),r.setAttribute("y2",i.y2),r.setAttribute("stroke",s),r.setAttribute("stroke-width",e),r.setAttribute("stroke-dasharray",o),n&&r.append(this.u(n)),r}static drawCircle(i,s,e,o,n=""){const r=document.createElementNS(t,"circle");return r.setAttribute("cx",i),r.setAttribute("cy",s),r.setAttribute("r",e),r.setAttribute("fill",o),n&&r.append(this.u(n)),r}static drawSquare(i,s,e,o,n=""){const r=document.createElementNS(t,"rect");return r.setAttribute("x",i),r.setAttribute("y",s),r.setAttribute("width",e),r.setAttribute("height",e),r.setAttribute("fill",o),n&&r.append(this.u(n)),r}static u(i){const s=document.createElementNS(t,"title");return s.append(document.createTextNode(i)),s.dataset.title=i,console.log(i),s}}class s{constructor(t,i=1900,s=1){this.l=t,this.m=i,this.p=Array.from(Array(s+1),(()=>new Array(t).fill(!1)))}setEntryRow(t){const i=this._(t.dataset.start),s=this._(this.g(t));let e=null,o=null,n=null;t.dataset.split&&(e=document.getElementById(t.dataset.split)),t.dataset.merge&&(e=document.getElementById(t.dataset.merge)),t.dataset.fork&&(e=document.getElementById(t.dataset.fork.split(" ")[0])),e&&null===n&&(e.dataset.row||this.setEntryRow(e),n=parseInt(e.dataset.row)),t.dataset.fork&&(o=document.getElementById(t.dataset.fork.split(" ")[1]),o.dataset.row||this.setEntryRow(o),this.k(e.dataset.row,this._(e.dataset.start)-1,this._(e.dataset.start)-1),this.k(o.dataset.row,this._(o.dataset.start)-1,this._(o.dataset.start)-1),n=Math.round((parseInt(e.dataset.row)+parseInt(o.dataset.row))/2));const r=this.I(t,i,s,n);t.dataset.row=r,this.S(t);try{this.v(r,i,s)}catch(i){console.log(`${i}: called for ${t.id} with row ${r}`)}t.dataset.fork&&(this.v(e.dataset.row,this._(e.dataset.start)-1,this._(e.dataset.start)-1),this.v(o.dataset.row,this._(o.dataset.start)-1,this._(o.dataset.start)-1))}_(t){return parseInt(t)-parseInt(this.m)}get rows(){return this.p.length}S(t){if(t.dataset.become){const i=document.getElementById(t.dataset.become);if(i.dataset.row){const t=i.dataset.start-this.m,s=i.dataset.end-this.m;this.k(i.dataset.row,t,s)}i.dataset.row=t.dataset.row,this.S(i)}}I(t,i,s,e=null){return t.dataset.row?t.dataset.row:e?this.M(parseInt(e),i,s):this.F(i,s)}g(t){let i=t.dataset.end;return t.dataset.become&&(i=this.g(document.getElementById(t.dataset.become))),i}F(t,i){for(let s=0;s<this.rows;s++)if(this.C(s,t,i))return s;return this.G(),this.rows-1}M(t,i,s){let e=t,o=t;if(this.C(t,i,s))return t;for(;e>-1&&!this.C(e,i,s);)e--;for(;o<this.rows&&!this.C(o,i,s);)o++;return-1==e&&o==this.rows?(this.G(),this.rows-1):o==this.rows?e:-1==e?o:t-e<=o-t?e:o}G(){this.p.push(new Array(this.l).fill(!1))}C(t,i,s){return this.p[t].slice(i,s).every((t=>!1===t))}v(t,i,s){this.P(t,i,s,!0)}k(t,i,s){this.P(t,i,s,!1)}P(t,i,s,e){if(!this.p[t])throw new Error(`Attempt to mark non-existent grid row ${t}`);let o=0;for(;o<s-i;)this.p[t][i+o]=e,o++;i>0&&(this.p[t][i-1]=e),s<this.p[0].length-1&&(this.p[t][s]=e)}}function e(t,i){let s={};for(const e in t)i.hasOwnProperty(e)?s[e]=i[e]:s[e]=t[e];return s}const o={yearStart:1900,yearEnd:(new Date).getFullYear()+1,strokeWidth:4,yearWidth:50,rowHeight:50,padding:5,strokeColour:"#999",boxWidth:100,guides:!0,guideInterval:5,entrySelector:"div"};class n{constructor(t,i={}){this.$=this.T(i),this.q(),this.R=document.getElementById(t),this.A=document.querySelectorAll("#"+t+" > "+this.$.entrySelector+":not(.timeline-exclude)")}T(t){const i=e(o,t);return i.boxHeight=i.rowHeight-2*i.padding,i.boxMinWidth=i.boxHeight,i}W(t,i){this.$[t]=i}create(){return this.D(),this.H(),this.L(),!0===this.$.guides&&this.O(),this.R}D(){this.j(),this.B(),this.R.classList.add("timeline-container"),this.R.style.height=(this.$.rows+2)*this.$.rowHeight+"px",this.R.style.width=(this.$.yearEnd+1-this.$.yearStart)*this.$.yearWidth+"px",this.J()}j(){for(const t of this.A)t.classList.add("entry"),t.dataset.end=t.dataset.end?t.dataset.end:this.N(t)}B(){let t=1;for(const i of this.A)parseInt(i.dataset.row)>t&&(t=parseInt(i.dataset.row));if("function"==typeof s){const i=this.$.yearEnd-this.$.yearStart,e=new s(i,this.$.yearStart,t);for(const t of this.A)e.setEntryRow(t);t=e.rows}this.W("rows",t)}J(){for(const t of this.A)t.style.left=this.X(t.dataset.start)+"px",t.style.top=(parseInt(t.dataset.row)+1)*this.$.rowHeight+this.$.padding+"px",t.dataset.colour&&(t.style.borderColor=t.dataset.colour),!0===this.Y(t)&&t.classList.add("min");for(const t of this.R.querySelectorAll(this.$.entrySelector+"[data-become]"))t.dataset.start==document.getElementById(t.dataset.become).dataset.start&&(t.style.left=parseFloat(t.style.left)-this.$.boxMinWidth/2+"px",document.getElementById(t.dataset.become).style.left=parseFloat(document.getElementById(t.dataset.become).style.left)+this.$.boxMinWidth/2+"px")}L(){const t=document.createElement("div");t.classList.add("dates");let i=this.$.yearStart;for(;i<this.$.yearEnd;){const s=document.createElement("date");s.style.left=this.X(i)+"px";const e=document.createTextNode(i);s.append(e),t.append(s),i+=5}this.R.prepend(t);const s=t.cloneNode(!0);s.style.top=this.$.rows*this.$.rowHeight+"px",this.R.append(s)}O(){let t=this.$.yearStart;for(;t<Math.ceil(this.$.yearEnd/this.$.guideInterval)*this.$.guideInterval;){const i=document.createElement("div");i.classList.add("guide"),i.style.left=this.X(t)+"px",i.style.width=this.$.yearWidth*this.$.guideInterval+"px",(t-this.$.yearStart)/this.$.guideInterval%2==1&&i.classList.add("odd"),this.R.append(i),t+=this.$.guideInterval}}H(){for(const t of this.A)!t.dataset.hasOwnProperty("end")||t.dataset.hasOwnProperty("merge")||t.dataset.hasOwnProperty("fork")||t.dataset.hasOwnProperty("become")||this.K(t),t.dataset.hasOwnProperty("split")&&this.U(t),t.dataset.hasOwnProperty("become")&&this.V(t),t.dataset.hasOwnProperty("merge")&&this.Z(t),t.dataset.hasOwnProperty("fork")&&this.tt(t),t.dataset.hasOwnProperty("links")&&this.it(t)}U(t){const s=document.getElementById(t.dataset.split),e=t.dataset.colour?t.dataset.colour:this.$.strokeColour;let o="top";parseInt(t.dataset.row)<parseInt(s.dataset.row)&&(o="bottom");let n={x:this.X(t.dataset.start),y:this.st(s)},r=this.et(t,o);const h=i.draw({start:n,end:r,stroke:this.$.strokeWidth,colour:e});h.classList.add("split"),this.R.append(h)}V(t){const s=this.et(t,"right"),e=this.et(document.getElementById(t.dataset.become),"left"),o=t.dataset.colour?t.dataset.colour:this.$.strokeColour,n=i.draw({start:s,end:e,stroke:this.$.strokeWidth,colour:o});n.classList.add("become"),this.R.append(n)}K(t){let s=this.et(t,"right"),e={x:this.X(t.dataset.end),y:this.et(t,"right").y};const o=t.dataset.colour?t.dataset.colour:this.$.strokeColour,n=t.dataset.endEstimate?"dots":"circle",r=i.draw({start:s,end:e,stroke:this.$.strokeWidth,colour:o,markers:["",n]});r.classList.add("end"),this.R.append(r)}Z(t){const s=this.et(t,"right"),e={x:this.X(t.dataset.end)-this.$.yearWidth,y:this.st(t)},o={x:this.X(t.dataset.end),y:this.st(document.getElementById(t.dataset.merge))},n=t.dataset.colour?t.dataset.colour:this.$.strokeColour,r=i.draw({start:s,end:e,stroke:this.$.strokeWidth,colour:n}),h=i.draw({start:e,end:o,stroke:this.$.strokeWidth,colour:n});r.classList.add("merge"),h.classList.add("merge"),this.R.append(r,h)}tt(t){const s=t.dataset.fork.split(" "),e=this.N(t),o=this.et(t,"right"),n={x:this.X(e),y:this.st(t)},r={x:this.X(e+1),y:this.st(document.getElementById(s[0]))},h={x:this.X(e+1),y:this.st(document.getElementById(s[1]))},c=t.dataset.colour?t.dataset.colour:this.$.strokeColour,a=i.draw({start:o,end:n,stroke:this.$.strokeWidth,colour:c}),d=i.draw({start:n,end:r,stroke:this.$.strokeWidth,colour:c}),u=i.draw({start:n,end:h,stroke:this.$.strokeWidth,colour:c});a.classList.add("fork"),d.classList.add("fork"),u.classList.add("fork"),this.R.append(a,d,u)}it(t){const s=t.dataset.links.split(" ");let e={top:-1,bottom:-1,left:-1,right:-1};for(const o of s){const s=document.getElementById(o),n=t.dataset.colour?t.dataset.colour:this.$.strokeColour;let r,h,c={x:0,y:0},a={x:0,y:0};const d=parseInt(t.dataset.row),u=parseInt(s.dataset.row);d===u&&t.dataset.start<s.dataset.start&&(e.right=e.right+1,r="right",h="left"),d===u&&t.dataset.start>s.dataset.start&&(e.left=e.left+1,r="left",h="right"),d>u&&(e.top=e.top+1,r="top",h="bottom"),d<u&&(e.bottom=e.bottom+1,r="bottom",h="top"),c=this.et(t,r,e[r]),a={x:c.x,y:this.st(s)},t.dataset.start>=s.dataset.end&&(a.x=this.X(s.dataset.end)),t.dataset.start==s.dataset.start&&(a=this.et(s,h));const l=i.draw({start:c,end:a,stroke:this.$.strokeWidth/2,colour:n,markers:["square","square"],dashes:"4"});l.classList.add("link"),this.R.append(l)}}q(){const t=document.documentElement;t.style.setProperty("--timeline-year-width",this.$.yearWidth+"px"),t.style.setProperty("--timeline-row-height",this.$.rowHeight+"px"),t.style.setProperty("--timeline-box-width",this.$.boxWidth+"px"),t.style.setProperty("--timeline-box-height",this.$.boxHeight+"px"),t.style.setProperty("--timeline-box-width-min",this.$.boxHeight+"px"),t.style.setProperty("--timeline-padding",this.$.padding+"px"),t.style.setProperty("--timeline-stroke-colour",this.$.strokeColour)}et(t,i,s=0){const e=window.getComputedStyle(t),o=parseFloat(t.style.left),n=parseFloat(t.style.top),r=parseFloat(e.getPropertyValue("width")),h=parseFloat(e.getPropertyValue("height"));switch(i){case"left":return{x:o,y:n+h/2+5*s};case"right":return{x:o+r,y:n+h/2+5*s};case"top":return{x:o+r/2+5*s,y:n};case"bottom":return{x:o+r/2+5*s,y:n+h};default:throw`Invalid element side specified: Called with ${i}. Entry: ${t}`}}N(t){if(t.dataset.end)return parseInt(t.dataset.end);if(t.dataset.become)return parseInt(document.getElementById(t.dataset.become).dataset.start);if(t.dataset.fork&&!t.dataset.end){const i=t.dataset.fork.split(" "),s=document.getElementById(i[0]),e=document.getElementById(i[1]);return parseInt(Math.max(s.dataset.start,e.dataset.start))}return parseInt(this.$.yearEnd)}Y(t){const i=t.dataset.start;return t.dataset.end-i<this.$.boxWidth/this.$.yearWidth}ot(t){return parseFloat(t.style.left)+this.$.boxWidth/2}st(t){return parseFloat(t.style.top)+this.$.boxHeight/2}X(t){return parseInt((t-this.$.yearStart)*this.$.yearWidth)}}const r={panzoom:!1,findForm:"timeline-find",zoomIn:"timeline-zoom-in",zoomOut:"timeline-zoom-out",zoomReset:"timeline-zoom-reset"};return class{constructor(t="diagram",i={}){this.R=t,this.nt(i)}create(){const t=new n(this.R,this.rt);this.ht=t.create(),!0===this.$.panzoom&&(this.ct(),this.at(),window.addEventListener("hashchange",(t=>this.dt(t)))),location.hash&&setTimeout((()=>{this.dt()}))}nt(t){this.$=e(r,t),this.rt=e(o,t)}panToEntry(t){if(!0!==this.$.panzoom)throw new Error("Panzoom not enabled. Enable Panzoom to use the pan-to-entry feature.");if(void 0===this.ut)throw new Error("Panzoom module missing. Include Panzoom to use the pan-to-entry feature.");const i=document.getElementById(t),s=window.innerWidth/2-parseInt(i.style.left)-this.rt.boxWidth/2,e=window.innerHeight/2-parseInt(i.style.top)-this.rt.rowHeight/2;this.ut.zoom(1),this.ut.pan(s,e);const o=new CustomEvent("timelineFind",{detail:{id:t,name:i.innerText}});document.getElementById(this.R).dispatchEvent(o),setTimeout((()=>{i.classList.add("highlight","hover")}),500),setTimeout((()=>{i.classList.remove("highlight","hover")}),2e3)}at(){const t=document.getElementById(this.$.zoomIn),i=document.getElementById(this.$.zoomOut),s=document.getElementById(this.$.zoomReset),e=document.getElementById(this.$.findForm);t&&t.addEventListener("click",this.ut.zoomIn),i&&i.addEventListener("click",this.ut.zoomOut),s&&s.addEventListener("click",(()=>this.ut.zoom(1))),e&&this.lt(e)}lt(t){const i=document.createElement("input");i.name="find-id",i.style.display="none",t.append(i);const s=t.querySelector("input[name=finder]"),e=document.createElement("div"),o=document.createElement("div"),n=document.createElement("ul");e.classList.add("filtered-entries"),e.appendChild(o),o.appendChild(n),s.parentNode.insertBefore(e,s),e.appendChild(s),s.autocomplete="off",o.style.width=s.offsetWidth+"px";const r={form:t,finder:s,id:i,results:n};this.ft=r,r.finder.value="",t.addEventListener("input",(t=>this.wt(t))),t.addEventListener("submit",(t=>this.yt(t))),n.addEventListener("click",(t=>this.xt(t)))}wt(t){const i=t.target.value;if(""===i.trim())return this.ft.results.innerHTML="",null;const s=this._t(i),e=this.ft.results;e.innerHTML="";for(const t of s){const i=document.createElement("li");i.dataset.id=t.id,i.innerText=t.name,e.append(i)}}_t(t){return[...document.querySelectorAll(".entry")].map((t=>({id:t.id,name:t.innerText}))).filter((i=>i.name.toLowerCase().includes(t.toLowerCase())))}xt(t){if("li"!==t.target.localName)return null;const i=this.ft.form,s=this.ft.finder,e=this.ft.id;s.value=t.target.innerText,e.value=t.target.dataset.id,i.requestSubmit()}yt(t){t.preventDefault();const i=t.target.querySelector("input[name=find-id]").value;t.target.querySelector("input[name=finder]").value,document.getElementById(i)&&this.panToEntry(i),this.ft.results.innerHTML="",this.ft.finder.value=""}ct(){if("undefined"==typeof Panzoom)throw new Error("Missing dependency. External Panzoom library (@panzoom/panzoom) is required to use the panzoom feature.");const t=document.createElement("div");t.classList.add("pz-wrap"),this.ht.parentNode.insertBefore(t,this.ht),t.appendChild(this.ht),this.ut=Panzoom(this.ht,{contain:"outside",maxScale:3,minScale:.5,step:.1,handleStartEvent:t=>{t.preventDefault()}}),this.ht.parentElement.addEventListener("wheel",this.ut.zoomWithWheel)}dt(t){const i=location.hash.replace("#find-","");document.getElementById(i)&&this.ut&&this.panToEntry(i)}}}));
