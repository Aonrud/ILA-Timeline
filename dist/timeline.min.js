/*! Timeline
 *Copyright (C) 2021-2024 Aonghus Storey
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(t="undefined"!=typeof globalThis?globalThis:t||self).Timeline=s()}(this,(function(){"use strict";const t="http://www.w3.org/2000/svg";class s{static draw({start:s,end:i,stroke:e,colour:n,markers:o=[],dashes:r="",title:h=""}={}){const c=2*e,a=i.x-s.x,d=i.y-s.y,l={x1:c,y1:c,x2:a+c,y2:d+c};i.x<s.x&&(l.x1+=Math.abs(a),l.x2+=Math.abs(a)),i.y<s.y&&(l.y1+=Math.abs(d),l.y2+=Math.abs(d));const u=Math.min(s.x,i.x)-c,f=Math.min(s.y,i.y)-c;let m=document.createElementNS(t,"svg");m.setAttribute("width",Math.abs(a)+2*c),m.setAttribute("height",Math.abs(d)+2*c),m.setAttribute("style","position: absolute; left: "+u+"px; top: "+f+"px"),m.style.color=n;const p=this.drawLine(l,e,r,h);return p.setAttribute("data-coords",`[ ${s.x}, ${s.y} ], [ ${i.x}, ${i.y} ]`),m.append(p),m=this.t(m,o[0],"start",l,e),m=this.t(m,o[1],"end",l,e),m}static t(t,s,i,e,n){return"circle"==s&&t.append(this.i(i,e,n)),"square"==s&&t.append(this.o(i,e,n)),"dots"==s&&"end"==i&&(t.setAttribute("width",parseInt(t.getAttribute("width"))+2*n),t.append(this.h(e,n))),t}static o(t,s,i){let[e,n]=[s.x1-i,s.y1-i];return"end"==t&&([e,n]=[s.x2-i,s.y2-i]),this.drawSquare(e,n,2.5*i)}static i(t,s,i){let[e,n]=[s.x1,s.y1];return"end"==t&&([e,n]=[s.x2,s.y2]),this.drawCircle(e,n,i)}static h(t,s){let i=t.x2;t.x2<t.x1&&(i=t.x2-5*s),t.x2>t.x1&&(i=t.x2+5*s);let e=t.y2;t.y2<t.y1&&(e=t.y2-2*s),t.y2>t.y1&&(e=t.y2+2*s);const n={x1:t.x2,y1:t.y2,x2:i,y2:e};return this.drawLine(n,s,`0 ${s} ${s} ${s} ${s}`)}static drawLine(s,i,e="",n=""){const o=document.createElementNS(t,"line");return o.setAttribute("x1",s.x1),o.setAttribute("y1",s.y1),o.setAttribute("x2",s.x2),o.setAttribute("y2",s.y2),o.setAttribute("stroke-width",i),o.setAttribute("stroke-dasharray",e),o.setAttribute("stroke","currentColor"),n&&o.append(this.l(n)),o}static drawCircle(s,i,e,n=""){const o=document.createElementNS(t,"circle");return o.setAttribute("cx",s),o.setAttribute("cy",i),o.setAttribute("r",e),o.setAttribute("fill","currentColor"),n&&o.append(this.l(n)),o}static drawSquare(s,i,e,n=""){const o=document.createElementNS(t,"rect");return o.setAttribute("x",s),o.setAttribute("y",i),o.setAttribute("width",e),o.setAttribute("height",e),o.setAttribute("fill","currentColor"),n&&o.append(this.l(n)),o}static l(s){const i=document.createElementNS(t,"title");return i.append(document.createTextNode(s)),i.dataset.title=s,i}}class i{constructor(){this.u=0,this.m=[]}findGridSpace(t,s,i=null){let e=i||Math.floor(this.m.length/2),n=!1;for(let i=0;i<this.m.length;i++)if(e=n?e-i:e+i,!(e<0||e>this.m.length-1)){if(this.checkGridSpace(e,t,s))return e;n=!n}return this.addGridRow(),this.m.length-1}addGridRowsUntil(t){for(;this.m.length-1!==t;)this.addGridRow();return this}addGridRow(){return this.m.push(new Array(this.u).fill(!1)),this}checkGridRange(t,s,i,e){for(;t!=s;){if(this.checkGridSpace(t,i,e))return t;t=t>s?parseInt(t)-1:parseInt(t)+1}}checkGridSpace(t,s,i){s===i&&(i+=1);return this.m[t].slice(s,i).every((t=>!1===t))}blockGridSpace(t,s,i){return this.p(t,s,i,this.m,!0),this.m}freeGridSpace(t,s,i){return this.p(t,s,i,this.m,!1),this.m}p(t,s,i,e){if(!this.m[t])throw new Error(`Attempt to mark non-existent this._grid row ${t}. Grid has length ${this.m.length}`);let n=0;for(;n<i-s;)this.m[t][s+n]=e,n++;return s>0&&(this.m[t][s-1]=e),i<this.m[0].length-1&&(this.m[t][i]=e),this.m}static compareGridRows(t,s){for(const[i,e]of t.entries())if(e&&s[i])return!1;return!0}get length(){return this.m.length}getRow(t){return this.m[t]}static getGridOverlap(t,s){let e=Math.min(t.length,s.length)-1;for(;e>0;){let n=!0;for(let o=0;o<e&&o<t.length;o++)if(!i.compareGridRows(t.getRow(t.length-e+o),s.getRow(o))){n=!1;break}if(1==n)return e;e--}return e}}class e{constructor(t,s,e){this.g=t,this._=s,this.v=e,this.k=e-s,this.m=new i,this.$=this.I(t),this.m.addGridRowsUntil(this.S(t));let n={};for(const t of this.$)n[t]=new i;this.O=n}calculate(){const t=[...this.g].filter((t=>t.dataset.group)),s=[...this.g].filter((t=>!t.dataset.group));this.C={};for(const s of t)this.j(s,!0);let e=0;this.$.forEach(((t,s)=>{const n=[...this.g].filter((s=>s.dataset.group==t));if(0!=s){const n=this.O[this.$[s-1]],o=i.getGridOverlap(n,this.O[t]);e-=o}for(const t of n)t.dataset.row=parseInt(t.dataset.groupRow)+e;this.C[t]=[e,e+this.O[t].length],e+=this.O[t].length}));const n=this.S(this.g);this.m.addGridRowsUntil(n);for(const t of[...this.g].filter((t=>t.dataset.row)))this.m.blockGridSpace(t.dataset.row,this.G(t.dataset.start),this.G(t.dataset.end),this.m);for(const s of t)(s.dataset.split||s.dataset.merge)&&this.M(s);for(const t of s)this.j(t)}get rows(){return this.m.length}I(t){return[...t].reduce(((t,s)=>(s.dataset.group&&!t.includes(s.dataset.group)&&t.push(s.dataset.group),t)),[])}S(t){const s=[...t].filter((t=>t.dataset.row));return s.length>0?Math.max(...s.map((t=>parseInt(t.dataset.row))))+1:1}M(t){const s=t.dataset.split?t.dataset.split:t.dataset.merge,i=document.getElementById(s);if(i.dataset.group!==t.dataset.group){let s=i.dataset.row-t.dataset.row>0?this.C[t.dataset.group][1]:this.C[t.dataset.group][0];const e=this.m.checkGridRange(s,t.dataset.row,this.G(t.dataset.start),this.G(this.F(t)));if(void 0!==e){this.R(t,e);const s=[...this.g].filter((s=>s.dataset.split==t.id||s.dataset.merge==t.id));for(const i of s)if(i.dataset.group==t.dataset.group){const s=this.m.checkGridRange(t.dataset.row,i.dataset.row,this.G(i.dataset.start),this.G(this.F(i)));void 0!==s&&this.R(i,s)}return}}}R(t,s){const i=this.G(t.dataset.start),e=this.G(this.F(t));this.m.freeGridSpace(t.dataset.row,i,e),t.dataset.row=s,this.T(t,"row",this.m),this.m.blockGridSpace(t.dataset.row,i,e)}j(t,s=!1){let i=this.m,e="row";if(s){if(!t.dataset.group)return;i=this.O[t.dataset.group],e="groupRow"}if(t.dataset[e])return;const n=this.G(t.dataset.start),o=this.G(this.F(t));let r=null,h=null;if(t.dataset.split&&(r=document.getElementById(t.dataset.split)),t.dataset.merge){const s=document.getElementById(t.dataset.merge);s.dataset.split!==t.id&&(r=s)}!r||s&&r.dataset.group!=t.dataset.group||(Object.hasOwn(r.dataset,e)||this.j(r,s),h=parseInt(r.dataset[e]));const c=i.findGridSpace(n,o,h);t.dataset[e]=c,this.T(t,e,i);try{i.blockGridSpace(c,n,o)}catch(s){console.warn(`${s}: called for ${t.id} with row ${c}`)}}T(t,s,i){if(t.dataset.become){const e=document.getElementById(t.dataset.become);t.dataset.group!==e.dataset.group&&(console.warn(`${t.id} and ${e.id} are directly connected but in separate groups. Amending ${e.id} to ${t.dataset.group}`),e.dataset.group=t.dataset.group),Object.hasOwn(e.dataset,s)&&i.freeGridSpace(e.dataset[s],this.G(e.dataset.start),this.G(e.dataset.end)),e.dataset[s]=t.dataset[s],this.T(e,s,i)}}F(t){let s=t.dataset.end;return t.dataset.become&&(s=this.F(document.getElementById(t.dataset.become))),s}G(t){return parseInt(t)-parseInt(this._)}}function n(t,s){let i={};for(const e in t)Object.hasOwn(s,e)?i[e]=s[e]:i[e]=t[e];return i}const o={yearStart:1900,yearEnd:(new Date).getFullYear()+1,strokeWidth:4,yearWidth:50,rowHeight:50,padding:5,boxWidth:100,guides:!0,guideInterval:5,entrySelector:"div",linkDashes:"4",irregularDashes:"88 4 4 4"};class r{constructor(t,s={}){this.D=this.q(s),this.P(),this.J=document.getElementById(t),this.g=document.querySelectorAll("#"+t+" > "+this.D.entrySelector+":not(.timeline-exclude):not(.event)"),this.L=this.J.querySelectorAll(".event")}q(t){const s=n(o,t);return s.boxHeight=s.rowHeight-2*s.padding,s.boxMinWidth=s.boxHeight,s}W(t,s){this.D[t]=s}create(){return this.A(),this.N(),this.H(),!0===this.D.guides&&this.U(),this.J}A(){this.X(),this.Y(),this.J.classList.add("timeline-container"),this.J.style.height=(this.D.rows+2)*this.D.rowHeight+"px",this.J.style.width=(this.D.yearEnd+1-this.D.yearStart)*this.D.yearWidth+"px",this.B(),this.K()}X(){for(const t of this.g){t.classList.add("entry"),t.dataset.end=this.V(t),parseInt(t.dataset.start)<this.D.yearStart&&(t.classList.add("preexists"),t.dataset.start=this.D.yearStart);for(const s of["become","split","merge","links"])if(Object.hasOwn(t.dataset,s))for(const i of t.dataset[s].split(" "))document.getElementById(i)||(console.warn(`${t.id}: Given ${s} ID "${i}" doesn't exist. Ignoring.`),delete t.dataset[s])}}Y(){let t=1;for(const s of this.g)parseInt(s.dataset.row)>t&&(t=parseInt(s.dataset.row));const s=new e(this.g,this.D.yearStart,this.D.yearEnd);s.calculate(),t=s.rows,this.W("rows",t)}B(){for(const t of this.g)t.style.left=this.Z(t.dataset.start)+"px",t.style.top=this.tt(t)+"px",t.dataset.colour&&(t.style.borderColor=t.dataset.colour),!0===this.st(t)&&t.classList.add("min");for(const t of this.J.querySelectorAll(this.D.entrySelector+"[data-become]"))t.dataset.start==document.getElementById(t.dataset.become).dataset.start&&(t.style.left=parseFloat(t.style.left)-this.D.boxMinWidth/2+"px",document.getElementById(t.dataset.become).style.left=parseFloat(document.getElementById(t.dataset.become).style.left)+this.D.boxMinWidth/2+"px")}K(){for(const t of this.L){if(t.dataset.target&&!document.getElementById(t.dataset.target)){console.warn(`Event has an invalid target â€“ skipping: ${JSON.stringify(t)}`);continue}let s=this.D.rowHeight-t.offsetHeight,i=this.Z(t.dataset.year);const e=[...this.L].filter((s=>!s.dataset.target&&s.dataset.year==t.dataset.year));e.length>1&&0!==e.indexOf(t)&&(s-=.5*t.offsetHeight*e.indexOf(t));const n=document.createElement("span");n.dataset.year=t.dataset.year,n.innerText=t.innerText,t.innerText="",t.append(n);let o=null;if(t.dataset.colour&&(o=t.dataset.colour),t.dataset.target){const e=document.getElementById(t.dataset.target);s=this.tt(e)+.5*(this.D.boxHeight-t.offsetHeight),i-=.5*t.offsetWidth,e.dataset.colour&&(o=e.dataset.colour)}if(o){const s=`colour-${o.replace(/[!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~]/g,"")}`;t.classList.add(s);let i=`.event.${s}:after { color: ${o}; border-color: ${o} }`;i+=`.event.${s}:hover { color: ${o} }`,this.it(i)}t.style.left=i+"px",t.style.top=s+"px"}}it(t){if(!document.getElementById("tl-styles")){const t=document.createElement("style");t.id="tl-styles",t.setAttribute("type","text/css"),document.head.append(t)}document.getElementById("tl-styles").append(document.createTextNode(t))}H(){const t=document.createElement("div");t.classList.add("dates");let s=this.D.yearStart;for(;s<this.D.yearEnd;){const i=document.createElement("date");i.style.left=this.Z(s)+"px";const e=document.createTextNode(s);i.append(e),t.append(i),s+=5}this.J.prepend(t);const i=t.cloneNode(!0);i.style.top=this.D.rows*this.D.rowHeight+"px",this.J.append(i)}U(){let t=this.D.yearStart;for(;t<Math.ceil(this.D.yearEnd/this.D.guideInterval)*this.D.guideInterval;){const s=document.createElement("div");s.classList.add("guide"),s.style.left=this.Z(t)+"px",s.style.width=this.D.yearWidth*this.D.guideInterval+"px",(t-this.D.yearStart)/this.D.guideInterval%2==1&&s.classList.add("odd"),this.J.append(s),t+=this.D.guideInterval}}N(){for(const t of this.g){const i=t.dataset.colour?t.dataset.colour:"var(--tl-colour-stroke)",e="true"==t.dataset.irregular?this.D.irregularDashes:"";let n="",o="end",r=this.et(t,"right"),h={x:this.Z(t.dataset.end),y:r.y};if(Object.hasOwn(t.dataset,"merge")||Object.hasOwn(t.dataset,"become")||(n=t.dataset.endEstimate?"dots":"circle"),Object.hasOwn(t.dataset,"become")&&(h=this.et(document.getElementById(t.dataset.become),"left"),o="become"),Object.hasOwn(t.dataset,"merge")){t.dataset.start==t.dataset.end&&(h.x+=this.D.yearWidth);const e={x:h.x,y:this.nt(document.getElementById(t.dataset.merge))};h.x=h.x-this.D.yearWidth;const n=s.draw({start:h,end:e,stroke:this.D.strokeWidth,colour:i});n.classList.add("merge"),this.J.append(n),o="merge"}if(t.dataset.start!==t.dataset.end){const t=s.draw({start:r,end:h,stroke:this.D.strokeWidth,colour:i,markers:["",n],dashes:e});t.classList.add(o),this.J.append(t)}Object.hasOwn(t.dataset,"split")&&this.ot(t,i),Object.hasOwn(t.dataset,"links")&&this.rt(t,i)}}ot(t,i){const e=document.getElementById(t.dataset.split);let n="top";parseInt(t.dataset.row)<parseInt(e.dataset.row)&&(n="bottom");const o={x:this.Z(t.dataset.start),y:this.nt(e)},r=this.et(t,n),h=s.draw({start:o,end:r,stroke:this.D.strokeWidth,colour:i});h.classList.add("split"),this.J.append(h)}rt(t,i){const e=t.dataset.links.split(" ");let n={top:-1,bottom:-1,left:-1,right:-1};for(const o of e){const e=document.getElementById(o);let r,h,c={x:0,y:0},a={x:0,y:0};const d=parseInt(t.dataset.row),l=parseInt(e.dataset.row);d===l&&t.dataset.start<e.dataset.start&&(n.right=n.right+1,r="right",h="left"),d===l&&t.dataset.start>e.dataset.start&&(n.left=n.left+1,r="left",h="right"),d>l&&(n.top=n.top+1,r="top",h="bottom"),d<l&&(n.bottom=n.bottom+1,r="bottom",h="top"),c=this.et(t,r,n[r]),a={x:c.x,y:this.nt(e)},t.dataset.start>=e.dataset.end&&(a.x=this.Z(e.dataset.end)),t.dataset.start==e.dataset.start&&(a=this.et(e,h));const u=s.draw({start:c,end:a,stroke:this.D.strokeWidth/2,colour:i,markers:["square","square"],dashes:this.D.linkDashes});u.classList.add("link"),this.J.append(u)}}P(){const t=document.documentElement;t.style.setProperty("--tl-width-year",this.D.yearWidth+"px"),t.style.setProperty("--tl-height-row",this.D.rowHeight+"px"),t.style.setProperty("--tl-width-box",this.D.boxWidth+"px"),t.style.setProperty("--tl-height-box",this.D.boxHeight+"px"),t.style.setProperty("--tl-width-box-min",this.D.boxHeight+"px"),t.style.setProperty("--tl-padding",this.D.padding+"px")}et(t,s,i=0){const e=window.getComputedStyle(t),n=parseFloat(t.style.left),o=parseFloat(t.style.top),r=parseFloat(e.getPropertyValue("width")),h=parseFloat(e.getPropertyValue("height"));switch(s){case"left":return{x:n,y:o+h/2+5*i};case"right":return{x:n+r,y:o+h/2+5*i};case"top":return{x:n+r/2+5*i,y:o};case"bottom":return{x:n+r/2+5*i,y:o+h};default:throw`Invalid element side specified: Called with ${s}. Entry: ${t}`}}V(t){return t.dataset.end?parseInt(t.dataset.end):t.dataset.become?parseInt(document.getElementById(t.dataset.become).dataset.start):parseInt(this.D.yearEnd)}tt(t){return parseInt((parseInt(t.dataset.row)+1)*this.D.rowHeight+this.D.padding)}st(t){const s=t.dataset.start;return t.dataset.end-s<this.D.boxWidth/this.D.yearWidth}ht(t){return parseFloat(t.style.left)+this.D.boxWidth/2}nt(t){return parseFloat(t.style.top)+this.D.boxHeight/2}Z(t){return parseInt((t-this.D.yearStart)*this.D.yearWidth)}}const h={panzoom:null,findForm:"timeline-find",zoomIn:"timeline-zoom-in",zoomOut:"timeline-zoom-out",zoomReset:"timeline-zoom-reset"};return class{constructor(t="diagram",s={},i=[],e=[]){this.J=t,this.ct(s);for(const t of i)this.addEntry(t);for(const t of e)this.addEvent(t)}create(){const t=new r(this.J,this.dt);this.lt=t.create(),"function"==typeof this.D.panzoom&&(this.ut(),this.ft(),window.addEventListener("hashchange",(t=>this.wt(t)))),location.hash&&setTimeout((()=>{this.wt()}))}ct(t){this.D=n(h,t),this.dt=n(o,t)}addEntry(t){if(document.getElementById(t.id))return void console.warn(`Invalid entry: ${t.id} already exists.`);if(!["id","name","start"].every((s=>Object.hasOwn(t,s))))return void console.warn(`Invalid entry: ${JSON.stringify(t)}. Entries must have at least id, name and start values.`);const s=document.createElement("div");s.id=t.id,s.innerText=t.name;for(const i of Object.keys(t))["id","name"].includes(i)||(s.dataset[i]=t[i]);document.getElementById(this.J).append(s)}addEvent(t){if(!t.year||!t.content)return void console.warn(`Invalid event: ${JSON.stringify(t)}. Events must have at least a year and content property.`);const s=document.createElement("div");s.classList.add("event"),s.innerText=t.content;for(const i of Object.keys(t))"content"!=i&&(s.dataset[i]=t[i]);document.getElementById(this.J).append(s)}panToEntry(t){if(void 0===this.yt)throw new Error("Panzoom module missing. Include Panzoom to use the pan-to-entry feature.");const s=document.getElementById(t),i=window.innerWidth/2-parseInt(s.style.left)-this.dt.boxWidth/2,e=window.innerHeight/2-parseInt(s.style.top)-this.dt.rowHeight/2;this.yt.zoom(1),this.yt.pan(i,e);const n=new CustomEvent("timelineFind",{detail:{id:t,name:s.innerText}});document.getElementById(this.J).dispatchEvent(n),setTimeout((()=>{s.classList.add("highlight","hover")}),500),setTimeout((()=>{s.classList.remove("highlight","hover")}),2e3)}ft(){const t=document.getElementById(this.D.zoomIn),s=document.getElementById(this.D.zoomOut),i=document.getElementById(this.D.zoomReset),e=document.getElementById(this.D.findForm);t&&t.addEventListener("click",this.yt.zoomIn),s&&s.addEventListener("click",this.yt.zoomOut),i&&i.addEventListener("click",(()=>this.yt.zoom(1))),e&&this.gt(e)}gt(t){const s=document.createElement("input");s.name="find-id",s.style.display="none",t.append(s);const i=t.querySelector("input[name=finder]"),e=document.createElement("div"),n=document.createElement("div"),o=document.createElement("ul");e.classList.add("filtered-entries"),e.appendChild(n),n.appendChild(o),i.parentNode.insertBefore(e,i),e.appendChild(i),i.autocomplete="off",n.style.width=i.offsetWidth+"px";const r={form:t,finder:i,id:s,results:o};this.xt=r,r.finder.value="",t.addEventListener("input",(t=>this._t(t))),t.addEventListener("submit",(t=>this.vt(t))),o.addEventListener("click",(t=>this.bt(t)))}_t(t){const s=t.target.value;if(""===s.trim())return this.xt.results.innerHTML="",null;const i=this.kt(s),e=this.xt.results;e.innerHTML="";for(const t of i){const s=document.createElement("li");s.dataset.id=t.id,s.innerText=t.name,e.append(s)}}kt(t){return[...document.querySelectorAll(".entry")].map((t=>({id:t.id,name:t.innerText}))).filter((s=>s.name.toLowerCase().includes(t.toLowerCase())))}bt(t){if("li"!==t.target.localName)return null;const s=this.xt.form,i=this.xt.finder,e=this.xt.id;i.value=t.target.innerText,e.value=t.target.dataset.id,s.requestSubmit()}vt(t){t.preventDefault();const s=t.target.querySelector("input[name=find-id]").value;document.getElementById(s)&&this.panToEntry(s),this.xt.results.innerHTML="",this.xt.finder.value=""}ut(){const t=document.createElement("div");t.classList.add("pz-wrap"),this.lt.parentNode.insertBefore(t,this.lt),t.appendChild(this.lt),this.yt=this.D.panzoom(this.lt,{contain:"outside",maxScale:3,minScale:.5,step:.1,handleStartEvent:t=>{t.preventDefault()}}),this.lt.parentElement.addEventListener("wheel",this.yt.zoomWithWheel)}wt(){const t=location.hash.replace("#find-","");document.getElementById(t)&&this.yt&&this.panToEntry(t)}}}));
