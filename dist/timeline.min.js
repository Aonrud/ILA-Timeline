/*! Timeline
 *Copyright (C) 2021 Aonghus Storey
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 *
 * This program is distributed in the hope that it will be useful,
 * but WITHOUT ANY WARRANTY; without even the implied warranty of
 * MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 * GNU General Public License for more details.
 *
 * You should have received a copy of the GNU General Public License
 * along with this program.  If not, see <http://www.gnu.org/licenses/>.
 */
!function(t,s){"object"==typeof exports&&"undefined"!=typeof module?module.exports=s():"function"==typeof define&&define.amd?define(s):(t="undefined"!=typeof globalThis?globalThis:t||self).Timeline=s()}(this,(function(){"use strict";const t="http://www.w3.org/2000/svg";class s{static draw({start:s,end:e,stroke:i,colour:n,markers:o=[],dashes:r="",title:h=""}={}){const c=2*i,a=e.x-s.x,d=e.y-s.y,l={x1:c,y1:c,x2:a+c,y2:d+c};e.x<s.x&&(l.x1+=Math.abs(a),l.x2+=Math.abs(a)),e.y<s.y&&(l.y1+=Math.abs(d),l.y2+=Math.abs(d));const u=Math.min(s.x,e.x)-c,m=Math.min(s.y,e.y)-c;let p=document.createElementNS(t,"svg");p.setAttribute("width",Math.abs(a)+2*c),p.setAttribute("height",Math.abs(d)+2*c),p.setAttribute("style","position: absolute; left: "+u+"px; top: "+m+"px"),p.style.color=n;const f=this.drawLine(l,i,r,h);return f.setAttribute("data-coords",`[ ${s.x}, ${s.y} ], [ ${e.x}, ${e.y} ]`),p.append(f),p=this.t(p,o[0],"start",l,i),p=this.t(p,o[1],"end",l,i),p}static t(t,s,e,i,n){return"circle"==s&&t.append(this.i(e,i,n)),"square"==s&&t.append(this.o(e,i,n)),"dots"==s&&"end"==e&&(t.setAttribute("width",parseInt(t.getAttribute("width"))+2*n),t.append(this.h(i,n))),t}static o(t,s,e){let[i,n]=[s.x1-e,s.y1-e];return"end"==t&&([i,n]=[s.x2-e,s.y2-e]),this.drawSquare(i,n,2.5*e)}static i(t,s,e){let[i,n]=[s.x1,s.y1];return"end"==t&&([i,n]=[s.x2,s.y2]),this.drawCircle(i,n,e)}static h(t,s){let e=t.x2;t.x2<t.x1&&(e=t.x2-5*s),t.x2>t.x1&&(e=t.x2+5*s);let i=t.y2;t.y2<t.y1&&(i=t.y2-2*s),t.y2>t.y1&&(i=t.y2+2*s);const n={x1:t.x2,y1:t.y2,x2:e,y2:i};return this.drawLine(n,s,`0 ${s} ${s} ${s} ${s}`)}static drawLine(s,e,i="",n=""){const o=document.createElementNS(t,"line");return o.setAttribute("x1",s.x1),o.setAttribute("y1",s.y1),o.setAttribute("x2",s.x2),o.setAttribute("y2",s.y2),o.setAttribute("stroke-width",e),o.setAttribute("stroke-dasharray",i),o.setAttribute("stroke","currentColor"),n&&o.append(this.l(n)),o}static drawCircle(s,e,i,n=""){const o=document.createElementNS(t,"circle");return o.setAttribute("cx",s),o.setAttribute("cy",e),o.setAttribute("r",i),o.setAttribute("fill","currentColor"),n&&o.append(this.l(n)),o}static drawSquare(s,e,i,n=""){const o=document.createElementNS(t,"rect");return o.setAttribute("x",s),o.setAttribute("y",e),o.setAttribute("width",i),o.setAttribute("height",i),o.setAttribute("fill","currentColor"),n&&o.append(this.l(n)),o}static l(s){const e=document.createElementNS(t,"title");return e.append(document.createTextNode(s)),e.dataset.title=s,e}}class e{constructor(t,s=1900,e=1){this.u=t,this.m=s,this.p=Array.from(Array(e+1),(()=>new Array(t).fill(!1)))}setEntryRow(t){const s=this.g(t.dataset.start),e=this.g(this._(t));let i=null,n=null;if(t.dataset.split&&(i=document.getElementById(t.dataset.split)),t.dataset.merge){const s=document.getElementById(t.dataset.merge);s.dataset.split!==t.id&&(i=s)}i&&null===n&&(i.dataset.row||this.setEntryRow(i),n=parseInt(i.dataset.row));const o=this.v(t,s,e,n);t.dataset.row=o,this.k(t);try{this.$(o,s,e)}catch(s){console.warn(`${s}: called for ${t.id} with row ${o}`)}}g(t){return parseInt(t)-parseInt(this.m)}get rows(){return this.p.length}k(t){if(t.dataset.become){const s=document.getElementById(t.dataset.become);if(s.dataset.row){const t=s.dataset.start-this.m,e=s.dataset.end-this.m;this.I(s.dataset.row,t,e)}s.dataset.row=t.dataset.row,this.k(s)}}v(t,s,e,i=null){return t.dataset.row?t.dataset.row:i?this.S(parseInt(i),s,e):this.C(s,e)}_(t){let s=t.dataset.end;return t.dataset.become&&(s=this._(document.getElementById(t.dataset.become))),s}C(t,s){let e=Math.floor(this.rows/2),i=!1;for(let n=0;n<this.rows;n++){if(e=i?e-n:e+n,this.O(e,t,s))return e;i=!i}return this.F(),this.rows-1}S(t,s,e){let i=t,n=t;if(this.O(t,s,e))return t;for(;i>-1&&!this.O(i,s,e);)i--;for(;n<this.rows&&!this.O(n,s,e);)n++;return-1==i&&n==this.rows?(this.F(),this.rows-1):n==this.rows?i:-1==i?n:t-i<=n-t?i:n}F(){this.p.push(new Array(this.u).fill(!1))}O(t,s,e){s===e&&(e+=1);return this.p[t].slice(s,e).every((t=>!1===t))}$(t,s,e){this.M(t,s,e,!0)}I(t,s,e){this.M(t,s,e,!1)}M(t,s,e,i){if(!this.p[t])throw new Error(`Attempt to mark non-existent grid row ${t}`);let n=0;for(;n<e-s;)this.p[t][s+n]=i,n++;s>0&&(this.p[t][s-1]=i),e<this.p[0].length-1&&(this.p[t][e]=i)}}function i(t,s){let e={};for(const i in t)Object.hasOwn(s,i)?e[i]=s[i]:e[i]=t[i];return e}const n={yearStart:1900,yearEnd:(new Date).getFullYear()+1,strokeWidth:4,yearWidth:50,rowHeight:50,padding:5,boxWidth:100,guides:!0,guideInterval:5,entrySelector:"div",linkDashes:"4",irregularDashes:"88 4 4 4"};class o{constructor(t,s={}){this.j=this.G(s),this.T(),this.D=document.getElementById(t),this.R=document.querySelectorAll("#"+t+" > "+this.j.entrySelector+":not(.timeline-exclude):not(.event)"),this.q=this.D.querySelectorAll(".event")}G(t){const s=i(n,t);return s.boxHeight=s.rowHeight-2*s.padding,s.boxMinWidth=s.boxHeight,s}A(t,s){this.j[t]=s}create(){return this.P(),this.J(),this.N(),!0===this.j.guides&&this.W(),this.D}P(){this.H(),this.L(),this.D.classList.add("timeline-container"),this.D.style.height=(this.j.rows+2)*this.j.rowHeight+"px",this.D.style.width=(this.j.yearEnd+1-this.j.yearStart)*this.j.yearWidth+"px",this.X(),this.Y()}H(){for(const t of this.R){t.classList.add("entry"),t.dataset.end=this.B(t),parseInt(t.dataset.start)<this.j.yearStart&&(t.classList.add("preexists"),t.dataset.start=this.j.yearStart);for(const s of["become","split","merge","links"])if(Object.hasOwn(t.dataset,s))for(const e of t.dataset[s].split(" "))document.getElementById(e)||(console.warn(`${t.id}: Given ${s} ID "${e}" doesn't exist. Ignoring.`),delete t.dataset[s])}}L(){let t=1;for(const s of this.R)parseInt(s.dataset.row)>t&&(t=parseInt(s.dataset.row));if("function"==typeof e){const s=this.j.yearEnd-this.j.yearStart,i=new e(s,this.j.yearStart,t);for(const t of this.R)i.setEntryRow(t);t=i.rows}this.A("rows",t)}X(){for(const t of this.R)t.style.left=this.K(t.dataset.start)+"px",t.style.top=this.U(t)+"px",t.dataset.colour&&(t.style.borderColor=t.dataset.colour),!0===this.V(t)&&t.classList.add("min");for(const t of this.D.querySelectorAll(this.j.entrySelector+"[data-become]"))t.dataset.start==document.getElementById(t.dataset.become).dataset.start&&(t.style.left=parseFloat(t.style.left)-this.j.boxMinWidth/2+"px",document.getElementById(t.dataset.become).style.left=parseFloat(document.getElementById(t.dataset.become).style.left)+this.j.boxMinWidth/2+"px")}Y(){for(const t of this.q){if(t.dataset.target&&!document.getElementById(t.dataset.target)){console.warn(`Event has an invalid target â€“ skipping: ${JSON.stringify(t)}`);continue}let s=this.j.rowHeight-t.offsetHeight,e=this.K(t.dataset.year);const i=[...this.q].filter((s=>!s.dataset.target&&s.dataset.year==t.dataset.year));i.length>1&&0!==i.indexOf(t)&&(s-=.5*t.offsetHeight*i.indexOf(t));const n=document.createElement("span");if(n.dataset.year=t.dataset.year,n.innerText=t.innerText,t.innerText="",t.append(n),t.dataset.colour){const s=`colour-${t.dataset.colour.replace(/[!"#$%&'()*+,./:;<=>?@[\\\]^`{|}~]/g,"")}`;t.classList.add(s);let e=`.event:not([data-target]).${s}:after { color: ${t.dataset.colour} }`;e+=`.event.${s}:hover span { color: ${t.dataset.colour} }`,this.Z(e)}if(t.dataset.target){const i=document.getElementById(t.dataset.target);if(s=this.U(i)+.5*(this.j.boxHeight-t.offsetHeight),e-=.5*t.offsetWidth,i.dataset.colour){const t=`.event[data-target="${i.id}"] {border-color: ${i.dataset.colour}; color: ${i.dataset.colour}; background-color: ${i.dataset.colour};}`;this.Z(t)}}t.style.left=e+"px",t.style.top=s+"px"}}Z(t){if(!document.getElementById("tl-styles")){const t=document.createElement("style");t.id="tl-styles",t.setAttribute("type","text/css"),document.head.append(t)}document.getElementById("tl-styles").append(document.createTextNode(t))}N(){const t=document.createElement("div");t.classList.add("dates");let s=this.j.yearStart;for(;s<this.j.yearEnd;){const e=document.createElement("date");e.style.left=this.K(s)+"px";const i=document.createTextNode(s);e.append(i),t.append(e),s+=5}this.D.prepend(t);const e=t.cloneNode(!0);e.style.top=this.j.rows*this.j.rowHeight+"px",this.D.append(e)}W(){let t=this.j.yearStart;for(;t<Math.ceil(this.j.yearEnd/this.j.guideInterval)*this.j.guideInterval;){const s=document.createElement("div");s.classList.add("guide"),s.style.left=this.K(t)+"px",s.style.width=this.j.yearWidth*this.j.guideInterval+"px",(t-this.j.yearStart)/this.j.guideInterval%2==1&&s.classList.add("odd"),this.D.append(s),t+=this.j.guideInterval}}J(){for(const t of this.R){const e=t.dataset.colour?t.dataset.colour:"var(--tl-colour-stroke)",i="true"==t.dataset.irregular?this.j.irregularDashes:"";let n="",o="end",r=this.tt(t,"right"),h={x:this.K(t.dataset.end),y:r.y};if(Object.hasOwn(t.dataset,"merge")||Object.hasOwn(t.dataset,"become")||(n=t.dataset.endEstimate?"dots":"circle"),Object.hasOwn(t.dataset,"become")&&(h=this.tt(document.getElementById(t.dataset.become),"left"),o="become"),Object.hasOwn(t.dataset,"merge")){t.dataset.start==t.dataset.end&&(h.x+=this.j.yearWidth);const i={x:h.x,y:this.st(document.getElementById(t.dataset.merge))};h.x=h.x-this.j.yearWidth;const n=s.draw({start:h,end:i,stroke:this.j.strokeWidth,colour:e});n.classList.add("merge"),this.D.append(n),o="merge"}if(t.dataset.start!==t.dataset.end){const t=s.draw({start:r,end:h,stroke:this.j.strokeWidth,colour:e,markers:["",n],dashes:i});t.classList.add(o),this.D.append(t)}Object.hasOwn(t.dataset,"split")&&this.et(t,e),Object.hasOwn(t.dataset,"links")&&this.it(t,e)}}et(t,e){const i=document.getElementById(t.dataset.split);let n="top";parseInt(t.dataset.row)<parseInt(i.dataset.row)&&(n="bottom");const o={x:this.K(t.dataset.start),y:this.st(i)},r=this.tt(t,n),h=s.draw({start:o,end:r,stroke:this.j.strokeWidth,colour:e});h.classList.add("split"),this.D.append(h)}it(t,e){const i=t.dataset.links.split(" ");let n={top:-1,bottom:-1,left:-1,right:-1};for(const o of i){const i=document.getElementById(o);let r,h,c={x:0,y:0},a={x:0,y:0};const d=parseInt(t.dataset.row),l=parseInt(i.dataset.row);d===l&&t.dataset.start<i.dataset.start&&(n.right=n.right+1,r="right",h="left"),d===l&&t.dataset.start>i.dataset.start&&(n.left=n.left+1,r="left",h="right"),d>l&&(n.top=n.top+1,r="top",h="bottom"),d<l&&(n.bottom=n.bottom+1,r="bottom",h="top"),c=this.tt(t,r,n[r]),a={x:c.x,y:this.st(i)},t.dataset.start>=i.dataset.end&&(a.x=this.K(i.dataset.end)),t.dataset.start==i.dataset.start&&(a=this.tt(i,h));const u=s.draw({start:c,end:a,stroke:this.j.strokeWidth/2,colour:e,markers:["square","square"],dashes:this.j.linkDashes});u.classList.add("link"),this.D.append(u)}}T(){const t=document.documentElement;t.style.setProperty("--tl-width-year",this.j.yearWidth+"px"),t.style.setProperty("--tl-height-row",this.j.rowHeight+"px"),t.style.setProperty("--tl-width-box",this.j.boxWidth+"px"),t.style.setProperty("--tl-height-box",this.j.boxHeight+"px"),t.style.setProperty("--tl-width-box-min",this.j.boxHeight+"px"),t.style.setProperty("--tl-padding",this.j.padding+"px")}tt(t,s,e=0){const i=window.getComputedStyle(t),n=parseFloat(t.style.left),o=parseFloat(t.style.top),r=parseFloat(i.getPropertyValue("width")),h=parseFloat(i.getPropertyValue("height"));switch(s){case"left":return{x:n,y:o+h/2+5*e};case"right":return{x:n+r,y:o+h/2+5*e};case"top":return{x:n+r/2+5*e,y:o};case"bottom":return{x:n+r/2+5*e,y:o+h};default:throw`Invalid element side specified: Called with ${s}. Entry: ${t}`}}B(t){return t.dataset.end?parseInt(t.dataset.end):t.dataset.become?parseInt(document.getElementById(t.dataset.become).dataset.start):parseInt(this.j.yearEnd)}U(t){return parseInt((parseInt(t.dataset.row)+1)*this.j.rowHeight+this.j.padding)}V(t){const s=t.dataset.start;return t.dataset.end-s<this.j.boxWidth/this.j.yearWidth}nt(t){return parseFloat(t.style.left)+this.j.boxWidth/2}st(t){return parseFloat(t.style.top)+this.j.boxHeight/2}K(t){return parseInt((t-this.j.yearStart)*this.j.yearWidth)}}const r={panzoom:null,findForm:"timeline-find",zoomIn:"timeline-zoom-in",zoomOut:"timeline-zoom-out",zoomReset:"timeline-zoom-reset"};return class{constructor(t="diagram",s={},e=[],i=[]){this.D=t,this.ot(s);for(const t of e)this.addEntry(t);for(const t of i)this.addEvent(t)}create(){const t=new o(this.D,this.rt);this.ht=t.create(),"function"==typeof this.j.panzoom&&(this.ct(),this.dt(),window.addEventListener("hashchange",(t=>this.lt(t)))),location.hash&&setTimeout((()=>{this.lt()}))}ot(t){this.j=i(r,t),this.rt=i(n,t)}addEntry(t){if(document.getElementById(t.id))return void console.warn(`Invalid entry: ${t.id} already exists.`);if(!["id","name","start"].every((s=>Object.hasOwn(t,s))))return void console.warn(`Invalid entry: ${JSON.stringify(t)}. Entries must have at least id, name and start values.`);const s=document.createElement("div");s.id=t.id,s.innerText=t.name;for(const e of Object.keys(t))["id","name"].includes(e)||(s.dataset[e]=t[e]);document.getElementById(this.D).append(s)}addEvent(t){if(!t.year||!t.content)return void console.warn(`Invalid event: ${JSON.stringify(t)}. Events must have at least a year and content property.`);const s=document.createElement("div");s.classList.add("event"),s.innerText=t.content;for(const e of Object.keys(t))"content"!=e&&(s.dataset[e]=t[e]);document.getElementById(this.D).append(s)}panToEntry(t){if(void 0===this.ut)throw new Error("Panzoom module missing. Include Panzoom to use the pan-to-entry feature.");const s=document.getElementById(t),e=window.innerWidth/2-parseInt(s.style.left)-this.rt.boxWidth/2,i=window.innerHeight/2-parseInt(s.style.top)-this.rt.rowHeight/2;this.ut.zoom(1),this.ut.pan(e,i);const n=new CustomEvent("timelineFind",{detail:{id:t,name:s.innerText}});document.getElementById(this.D).dispatchEvent(n),setTimeout((()=>{s.classList.add("highlight","hover")}),500),setTimeout((()=>{s.classList.remove("highlight","hover")}),2e3)}dt(){const t=document.getElementById(this.j.zoomIn),s=document.getElementById(this.j.zoomOut),e=document.getElementById(this.j.zoomReset),i=document.getElementById(this.j.findForm);t&&t.addEventListener("click",this.ut.zoomIn),s&&s.addEventListener("click",this.ut.zoomOut),e&&e.addEventListener("click",(()=>this.ut.zoom(1))),i&&this.ft(i)}ft(t){const s=document.createElement("input");s.name="find-id",s.style.display="none",t.append(s);const e=t.querySelector("input[name=finder]"),i=document.createElement("div"),n=document.createElement("div"),o=document.createElement("ul");i.classList.add("filtered-entries"),i.appendChild(n),n.appendChild(o),e.parentNode.insertBefore(i,e),i.appendChild(e),e.autocomplete="off",n.style.width=e.offsetWidth+"px";const r={form:t,finder:e,id:s,results:o};this.yt=r,r.finder.value="",t.addEventListener("input",(t=>this.wt(t))),t.addEventListener("submit",(t=>this.xt(t))),o.addEventListener("click",(t=>this.gt(t)))}wt(t){const s=t.target.value;if(""===s.trim())return this.yt.results.innerHTML="",null;const e=this._t(s),i=this.yt.results;i.innerHTML="";for(const t of e){const s=document.createElement("li");s.dataset.id=t.id,s.innerText=t.name,i.append(s)}}_t(t){return[...document.querySelectorAll(".entry")].map((t=>({id:t.id,name:t.innerText}))).filter((s=>s.name.toLowerCase().includes(t.toLowerCase())))}gt(t){if("li"!==t.target.localName)return null;const s=this.yt.form,e=this.yt.finder,i=this.yt.id;e.value=t.target.innerText,i.value=t.target.dataset.id,s.requestSubmit()}xt(t){t.preventDefault();const s=t.target.querySelector("input[name=find-id]").value;document.getElementById(s)&&this.panToEntry(s),this.yt.results.innerHTML="",this.yt.finder.value=""}ct(){const t=document.createElement("div");t.classList.add("pz-wrap"),this.ht.parentNode.insertBefore(t,this.ht),t.appendChild(this.ht),this.ut=this.j.panzoom(this.ht,{contain:"outside",maxScale:3,minScale:.5,step:.1,handleStartEvent:t=>{t.preventDefault()}}),this.ht.parentElement.addEventListener("wheel",this.ut.zoomWithWheel)}lt(){const t=location.hash.replace("#find-","");document.getElementById(t)&&this.ut&&this.panToEntry(t)}}}));
